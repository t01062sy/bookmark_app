# ブックマークアプリ 開発計画書

**作成日：** 2025年8月10日  
**最終更新：** 2025年8月10日  
**対象フェーズ：** Phase 1A 完了 → Phase 1B 以降の開発計画

---

## 1. 現在の開発状況（Phase 1A 完了状況）

### ✅ 完了済み項目

#### 1.1 iOS アプリ（SwiftUI + Swift Data）
- **基本アーキテクチャ**: SwiftUI + Swift Data + MVVM パターン
- **データモデル完全実装**:
  - `Bookmark.swift`: 完全な Swift Data モデル（23フィールド）
  - `SourceType`, `BookmarkCategory`, `LLMStatus` の enum 実装
  - ローカルデータ永続化対応
- **UI画面完全実装**:
  - `ContentView.swift`: メイン一覧画面（検索・フィルタ・ピン留め対応）
  - `BookmarkDetailView.swift`: 詳細表示（Safari連携・共有・編集アクション）
  - `AddBookmarkView.swift`: URL追加（クリップボード検知・ダミーLLM処理）
  - `EditBookmarkView.swift`: 手動編集（タイトル・要約・タグ・カテゴリ）
- **サンプルデータ**: 13件の多様なテストデータ（YouTube、X、記事、論文等）
- **動作確認**: iOS Simulator で全機能テスト完了、色エラー修正済み

#### 1.2 設計ドキュメント
- **要件定義書**: 機能要件・非機能要件・KPI 詳細定義済み
- **API 仕様書**: OpenAPI 3.0 形式で全エンドポイント設計済み
- **データモデル設計**: PostgreSQL + pgvector スキーマ設計済み
- **アーキテクチャ設計**: C4モデル Level 1、技術スタック決定済み

### ✅ Phase 1B Week 1 完了済み（2025年8月10日）

#### 1.3 Supabase バックエンド基盤
- **プロジェクト作成**: ieuurvmlrgkxfetfnlnp 完全構築済み ✅
- **データベーススキーマ**: 2テーブル、25フィールド、11インデックス完成 ✅
- **セキュリティ設定**: RLS有効化、6つのポリシー設定完了 ✅
- **ストレージ**: thumbnails バケット作成済み ✅
- **動作確認**: SQL Editor + ブラウザでAPI基本動作確認済み ✅
- **認証情報管理**: .secrets ファイルで安全管理完了 ✅

### ✅ Phase 1B Week 2 完了済み（2025年8月10日）

#### 1.4 Edge Functions API実装
- **POST /v1/bookmarks API**: 基本保存機能完全実装済み ✅
  - URL重複チェック、冪等性キー対応、自動ソースタイプ判定
  - バリデーション・エラーハンドリング、CORS対応
- **GET /v1/bookmarks API**: 検索・フィルタ機能完全実装済み ✅
  - テキスト検索、カテゴリ・タグ・ソースタイプフィルタ
  - ページネーション、ソート機能、メタデータ付きレスポンス
- **デプロイ・テスト**: Supabase Edge Functions正常稼働確認済み ✅
  - 基本CRUD、検索・フィルタ、冪等性すべて動作確認完了

### 🚧 部分実装・課題

#### 1.4 iOS アプリの制限事項
- **Share Extension 未実装**: Apple Developer Account が必要（実機配布時に実装予定）
- **API 通信未実装**: バックエンドAPI（Edge Functions）完成後に統合予定
- **認証機能未実装**: WebAuthn パスキー（Phase 1B Week 2で実装予定）
- **プッシュ通知未実装**: 通知フレームワーク未統合

### 🚧 部分完了・継続項目

#### 1.5 バックエンド API（Phase 1B Week 3で継続）
- **Edge Functions**: 基本API完成 ✅（POST/GET bookmarks API）
- **メタデータ取得**: OGP/oEmbed パーサー未実装 ❌
- **URL正規化**: UTM除去・リダイレクト解決未実装 ❌
- **認証エンドポイント**: WebAuthn API未実装 ❌

#### 1.5 Web アプリ（React PWA）
- **プロジェクト未作成**: React + TypeScript + PWA 環境未構築
- **UI 未実装**: 全画面未作成
- **オフライン対応**: Service Worker 未実装
- **プッシュ通知**: Web Push 未実装

#### 1.6 補助機能
- **Web ブックマークレット**: JavaScript 未作成
- **LLM パイプライン**: OpenAI API 連携未実装
- **検索エンジン**: BM25 + ベクトル検索未実装

---

## 2. 技術スタック・インフラ構成

### 2.1 確定済み技術スタック
```
Frontend:
├── iOS: SwiftUI + Swift Data (iOS 17+) ✅
├── Web: React + TypeScript + PWA Level 2 ❌
└── Bookmarklet: Vanilla JavaScript ❌

Backend:
├── BaaS: Supabase (PostgreSQL + Edge Functions) ✅
├── 検索: BM25 + pgvector ベクトル検索 ✅🚧
├── LLM: OpenAI GPT-4o-mini (フォールバック: GPT-4o) ❌
├── 認証: WebAuthn パスキー (単一デバイス) ❌
└── ストレージ: Supabase Storage ✅

DevOps:
├── 監視: Supabase Analytics ❌
├── CI/CD: GitHub Actions ❌
└── コスト監視: OpenAI Usage API ❌
```

### 2.2 運用制限
- **LLM コスト上限**: $1/日、$30/月
- **処理能力上限**: 10,000 ブックマーク/月/ユーザー
- **単一ユーザー**: ユーザー登録不要、パスキー認証のみ
- **データ保持**: ブックマーク永続、ログ 10 日間

---

## 3. 開発ロードマップ（Phase 1B 以降）

### Phase 1B: バックエンド基盤構築 【優先度: 最高】
**期間目安**: 2-3 週間  
**目標**: iOS アプリと API 連携完了

#### 🎯 Phase 1B - Week 1: Supabase セットアップ
- [ ] **Supabase プロジェクト作成**
  - アカウント作成・プロジェクト初期化
  - データベース接続確認
- [ ] **データベース スキーマ作成**
  - `bookmarks` テーブル作成（22 フィールド）
  - `idempotency_keys` テーブル作成
  - インデックス設定（URL unique、created_at、tags GIN）
  - pgvector 拡張有効化
- [ ] **認証設定**
  - WebAuthn プロバイダー設定
  - RLS (Row Level Security) ポリシー設定
- [ ] **ストレージ設定**
  - サムネイル用バケット作成
  - パブリックアクセス設定

#### ✅ Phase 1B - Week 2: 基本 API 実装 【完了済み】
- [x] **Edge Functions 作成**
  - `POST /v1/bookmarks` (基本保存) ✅
  - `GET /v1/bookmarks` (一覧取得・検索) ✅
  - `POST /v1/auth/webauthn/*` (認証エンドポイント) ❌ 次フェーズ
- [x] **基本機能実装**
  - URL重複チェック・冪等性対応 ✅
  - 自動ソースタイプ判定 ✅
  - テキスト検索・フィルタ機能 ✅
- [x] **エラーハンドリング**
  - バリデーション処理 ✅
  - エラーレスポンス統一 ✅
  - CORS対応 ✅
- [ ] **メタデータ取得機能** ❌ Phase 1B Week 3実装予定
  - OGP/oEmbed パーサー実装
  - URL 正規化処理（UTM 除去、リダイレクト解決）
  - YouTube・X・記事サイト別対応

#### 🎯 Phase 1B - Week 3: iOS アプリ統合
- [ ] **iOS アプリ API 統合**
  - URLSession ベース HTTP クライアント実装
  - `AddBookmarkView` の API 連携
  - 認証トークン管理
  - オフライン・オンライン状態管理
- [ ] **データ同期機能**
  - ローカル Swift Data ↔ Supabase 同期
  - 競合解決ロジック
  - バックグラウンド同期
- [ ] **iOS テスト・デバッグ**
  - シミュレーター + 実機テスト
  - ログ・エラー監視機能追加
  - パフォーマンス測定

### Phase 2A: LLM 処理パイプライン 【優先度: 高】
**期間目安**: 2-3 週間  
**目標**: 自動要約・分類機能完成

#### 🎯 Phase 2A - Week 1: LLM 基盤構築
- [ ] **OpenAI API 連携**
  - API キー設定・ローテーション機能
  - `gpt-4o-mini` 基本連携
  - コスト監視・上限設定（$1/日、$30/月）
- [ ] **コンテンツ抽出機能**
  - Readability.js 統合（本文抽出）
  - YouTube Data API 連携（動画メタデータ）
  - X API 連携（ツイート内容取得）
- [ ] **プロンプト設計**
  - タイトル補正・要約・分類用プロンプト
  - JSON Schema バリデーション
  - 多言語対応（日本語・英語）

#### 🎯 Phase 2A - Week 2: 非同期処理・キュー
- [ ] **Supabase Functions キュー実装**
  - ジョブキュー（queued → processing → done/failed）
  - 再試行ロジック（最大 2 回）
  - DLQ（Dead Letter Queue）
- [ ] **バッチ処理機能**
  - 並列 LLM 処理（レート制限考慮）
  - 優先度付きキュー（ピン留めブックマーク優先）
  - 処理状況リアルタイム更新

#### 🎯 Phase 2A - Week 3: 品質・監視
- [ ] **LLM 出力品質向上**
  - few-shot プロンプト（サンプル例追加）
  - フォールバック処理（gpt-4o-mini → gpt-4o）
  - 出力検証・サニタイゼーション
- [ ] **監視・アラート**
  - トークン消費量追跡
  - 処理成功率監視
  - コスト閾値超過アラート
  - LLM API エラー監視（401/429/500）

### Phase 2B: 検索・フィルタ機能強化 【優先度: 中】
**期間目安**: 1-2 週間  
**目標**: 高精度検索機能完成

#### 🎯 Phase 2B: 高度な検索機能
- [ ] **pgvector ベクトル検索実装**
  - OpenAI Embedding API 連携
  - ベクトルインデックス最適化
  - BM25 + ベクトル検索ハイブリッド（RRF ランキング）
- [ ] **全文検索強化**
  - PostgreSQL 日本語全文検索（pg_bigm）
  - タグ・カテゴリ複合検索
  - 日付範囲・ソース種別フィルタ
- [ ] **iOS アプリ検索 UI 改善**
  - 検索結果ハイライト
  - 検索履歴・サジェスト
  - 高度なフィルタ UI

### Phase 3A: Web アプリ（PWA）開発 【優先度: 中】
**期間目安**: 3-4 週間  
**目標**: オフライン対応 Web アプリ完成

#### 🎯 Phase 3A - Week 1-2: React PWA 基盤
- [ ] **プロジェクト初期化**
  - Create React App + PWA テンプレート
  - TypeScript + Tailwind CSS 設定
  - Service Worker 設定
- [ ] **基本画面実装**
  - ブックマーク一覧（iOS アプリと同等）
  - 詳細表示・編集画面
  - 認証画面（WebAuthn）
- [ ] **API 連携**
  - Supabase JavaScript クライアント統合
  - リアルタイム同期（Supabase Realtime）
  - オフライン対応（IndexedDB キャッシュ）

#### 🎯 Phase 3A - Week 3-4: PWA 機能完成
- [ ] **オフライン機能**
  - Service Worker キャッシュ戦略
  - オフライン保存キュー
  - オンライン復帰時の自動同期
- [ ] **プッシュ通知**
  - Web Push API 実装
  - LLM 処理完了通知
  - 重要ブックマーク通知
- [ ] **モバイル最適化**
  - レスポンシブデザイン
  - PWA インストール促進
  - ホーム画面アイコン・スプラッシュ設定

### Phase 3B: Web ブックマークレット 【優先度: 中】
**期間目安**: 1 週間  
**目標**: 1 クリック保存機能完成

#### 🎯 Phase 3B: ブックマークレット実装
- [ ] **JavaScript ブックマークレット作成**
  - 現在ページの URL・タイトル自動取得
  - API 連携（認証トークン管理）
  - 保存成功・失敗フィードバック UI
- [ ] **クロスブラウザ対応**
  - Chrome、Safari、Firefox、Edge 対応
  - CORS 対応
  - セキュリティポリシー準拠
- [ ] **インストール・使用説明**
  - ブックマークレットのインストール手順
  - 動作確認・トラブルシューティングガイド

### Phase 4A: iOS Share Extension 【優先度: 中】
**期間目安**: 1-2 週間  
**目標**: ワンタップ保存機能完成  
**前提**: Apple Developer Account 取得済み

#### 🎯 Phase 4A: Share Extension 実装
- [ ] **Share Extension ターゲット追加**
  - Xcode プロジェクト Share Extension 追加
  - App Groups 設定（メインアプリとのデータ共有）
- [ ] **Share Extension UI**
  - 最小 UI（保存ボタンのみ）
  - エラーハンドリング・フィードバック
  - バックグラウンド保存処理
- [ ] **Ad Hoc 配布**
  - TestFlight 経由のベータ配布
  - 実機テスト・フィードバック収集

### Phase 4B: 運用・監視機能 【優先度: 低】
**期間目安**: 1-2 週間  
**目標**: 本番運用準備完了

#### 🎯 Phase 4B: 運用機能
- [ ] **監視ダッシュボード**
  - Supabase Dashboard カスタマイズ
  - 日別保存件数・LLM コスト・成功率グラフ
  - アラート設定（コスト・エラー率閾値）
- [ ] **バックアップ・復旧**
  - 定期データベースバックアップ
  - エクスポート機能（JSON/CSV）
  - インシデント対応手順書
- [ ] **パフォーマンス最適化**
  - データベースクエリ最適化
  - CDN 設定（静的ファイル）
  - キャッシュ戦略最適化

---

## 4. 次回開発での最優先タスク

### 🚀 即座に開始すべきタスク（Phase 1B Week 1）

1. **Supabase プロジェクト作成** (0.5 日)
   - [Supabase.com](https://supabase.com) でアカウント作成
   - 新規プロジェクト作成・データベース接続確認
   
2. **データベース スキーマ作成** (1 日)
   ```sql
   -- bookmarks テーブル作成
   CREATE TABLE bookmarks (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     url TEXT NOT NULL,
     canonical_url TEXT,
     domain TEXT NOT NULL,
     source_type bookmark_source_type NOT NULL,
     title_raw TEXT,
     title_final TEXT NOT NULL,
     summary TEXT DEFAULT '',
     tags JSONB DEFAULT '[]'::jsonb,
     category bookmark_category DEFAULT 'other',
     content_text TEXT,
     embedding vector(1536),
     created_at TIMESTAMPTZ DEFAULT NOW(),
     updated_at TIMESTAMPTZ DEFAULT NOW(),
     read_at TIMESTAMPTZ,
     pinned BOOLEAN DEFAULT FALSE,
     archived BOOLEAN DEFAULT FALSE,
     hash TEXT,
     canonical_hash TEXT,
     llm_status llm_status_type DEFAULT 'queued'
   );
   
   -- インデックス作成
   CREATE UNIQUE INDEX bookmarks_url_unique ON bookmarks(LOWER(url));
   CREATE INDEX bookmarks_created_at_desc ON bookmarks(created_at DESC);
   CREATE INDEX bookmarks_tags_gin ON bookmarks USING gin(tags);
   ```

3. **最初の API エンドポイント実装** (1-2 日)
   - `POST /v1/bookmarks` - 基本保存機能
   - `GET /v1/bookmarks` - 一覧取得
   - Supabase Edge Functions で実装

4. **iOS アプリ API 連携** (1 日)
   - URLSession HTTP クライアント作成
   - `AddBookmarkView` でのサーバー通信実装
   - エラーハンドリング強化

### 📋 準備作業チェックリスト

- [ ] Supabase アカウント作成済み
- [ ] OpenAI API アカウント・キー取得済み
- [ ] 開発用クレジットカード設定済み（Supabase・OpenAI）
- [ ] Git リポジトリ管理体制確立
- [ ] iOS 実機テスト環境準備済み（Apple ID・デバイス）

---

## 5. 成功指標・品質基準

### 5.1 Phase 1B 完了基準
- [ ] iOS アプリから Supabase API 経由でブックマーク保存成功
- [ ] 保存データが PostgreSQL に正しく格納
- [ ] 基本認証（パスキー）動作確認
- [ ] API レスポンス時間 P95 < 1.2 秒

### 5.2 Phase 2A 完了基準  
- [ ] LLM 自動要約・分類成功率 ≥ 95%
- [ ] LLM 処理時間 P95 < 20 秒
- [ ] 日次 LLM コスト < $1.00
- [ ] 失敗ブックマークの手動再試行機能動作

### 5.3 Phase 3A 完了基準
- [ ] Web PWA でオフライン保存・オンライン同期成功
- [ ] PWA インストール・プッシュ通知動作
- [ ] iOS・Web 間でのリアルタイムデータ同期確認
- [ ] Lighthouse PWA Score ≥ 90

### 5.4 最終成功基準（全 Phase 完了）
- [ ] **保存平均タップ数** ≤ 1.2 回
- [ ] **保存→要約完了時間** P95 < 20 秒  
- [ ] **検索 1 回でのヒット率** ≥ 80%
- [ ] **月次運用コスト** < $30（LLM + インフラ）
- [ ] **API 稼働率** ≥ 99.9%/月

---

## 6. リスクと対策

### 6.1 技術リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| OpenAI API コスト急騰 | 高 | 使用量監視、上限設定、gpt-4o-mini 優先使用 |
| Supabase 制限・障害 | 中 | 代替 BaaS 調査、データエクスポート機能 |
| LLM 出力品質低下 | 中 | few-shot 学習、フォールバック処理、手動編集機能 |
| iOS Share Extension 審査 | 低 | TestFlight ベータ配布、段階的リリース |

### 6.2 開発リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| スケジュール遅延 | 中 | MVP 機能に集中、段階的リリース |
| 単一開発者リソース不足 | 高 | タスク優先順位付け、外部ライブラリ活用 |
| Apple Developer Account 遅延 | 低 | Simulator 開発継続、Account 取得後 Extension 追加 |

### 6.3 運用リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| API キー漏えい | 高 | 定期ローテーション、サーバーサイド管理 |
| データ損失 | 高 | 定期バックアップ、エクスポート機能 |
| 不正利用・過剰使用 | 中 | レート制限、認証強化、監視アラート |

---

## 7. まとめ・次回アクション

### 🎯 現在地
- **Phase 1A (iOS プロトタイプ)** ✅ **完成** - 全機能動作確認済み
- **Phase 1B Week 1 (Supabase基盤)** ✅ **完成** - データベース・セキュリティ構築済み
- **Phase 1B Week 2 (Edge Functions)** ✅ **完成** - POST/GET API稼働中
- **Phase 1B Week 3 (iOS統合)** 🚧 **次回開始** - API連携から

### 🚀 最優先アクション（Phase 1B Week 3）
1. **iOS アプリ URLSession HTTPクライアント実装** (1-2 日)
2. **AddBookmarkView API連携** (1-2 日) 
3. **データ同期機能（Swift Data ↔ Supabase）** (2-3 日)

### 📊 開発期間見積もり（更新）
- **Phase 1B (バックエンド基盤)**: ✅ **完了済み（2週間）** - Week1: DB、Week2: API
- **Phase 1B Week 3 (iOS統合)**: 1週間 - 残り1週間
- **Phase 2A (LLM パイプライン)**: 2-3 週間
- **Phase 3A (Web PWA)**: 3-4 週間
- **合計 MVP 完成まで**: **6-9 週間（短縮）**

### 💡 成功の鍵
- **段階的リリース**: 各 Phase で動作する成果物を作成
- **品質重視**: テスト・エラーハンドリング・監視を各 Phase で実装
- **コスト管理**: LLM 使用量とインフラコストの厳格な監視
- **ユーザビリティ**: 保存操作の最小化（タップ数 ≤ 1.2）を常に意識

---

**開発計画書 作成完了** 🎉  
次回開発時は「Phase 1B Week 1: Supabase セットアップ」から開始してください。